<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>Accueil</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>
<body>
<header class="d-flex align-items-center justify-content-between border-bottom p-3 my-3 text-light bg-dark">
    <h1>Bienvenue sur la page d'accueil</h1>
    <div class="d-flex gap-3">
        <p class="m-0 d-flex align-items-center">Bonjour <span th:text="${prenom}"></span></p>
        <form th:action="@{/logout}" method="post">
            <button class="btn btn-primary btn-sm" type="submit">
                Déconnectez-vous
            </button>
        </form>
    </div>
</header>

<main class="p-4">

<div class="d-flex align-items-center justify-content-between mb-3">

<h2>Tableau de bord - Année <span th:text="${annee}"></span></h2>

    <div class="d-flex gap-2 align-items-center">
        <!-- Boutons d'action -->
        <a th:href="@{/ASTA/ajouterApprenti}" class="btn btn-success btn-sm">
            + Nouvel apprenti
        </a>
        <a th:href="@{/ASTA/nouvelleAnnee}" class="btn btn-primary btn-sm">
            + Nouvelle année académique
        </a>
        <form method="get" th:action="@{/home}">
            <label for="annee">Année académique :</label>
            <select id="annee" name="annee" onchange="this.form.submit()">
                <option th:each="a : ${annees}"
                        th:value="${a}"
                        th:text="${a}"
                        th:selected="${a == anneeSelectionnee}">
                </option>
            </select>
        </form>
    </div>

</div>

<form method="get" th:action="@{/home}" class="d-flex align-items-center justify-content-between gap-4 mb-3">
    <label for="searchInput" class="visually-hidden">Recherche</label>
    <input id="searchInput" type="text" name="search" th:value="${search}" placeholder="Rechercher un apprenti, une entreprise ou une mission..." class="w-100" aria-label="Recherche">
</form>

<div th:if="${#lists.isEmpty(apprentis)}" class="text-danger">
    La liste est vide. Ajoutez au moins un apprenti.
</div>

<table th:if="${!#lists.isEmpty(apprentis)}" id="apprentisTable" class="table table-striped table-hover table-bordered">
    <thead>
    <tr>
        <th>Nom</th>
        <th>Prénom</th>
        <th>Actions</th>

    </tr>
    </thead>
    <tbody>
    <tr th:each="a : ${apprentis}">
        <td th:text="${a.nom}"></td>
        <td th:text="${a.prenom}"></td>
        <td>
            <a th:href="@{/ASTA/detailsApprenti/{id}(id=${a.id})}" class="btn btn-sm btn-primary">
                Voir détails
            </a>
        </td>
    </tr>
    </tbody>
</table>

</main>
<script>
    (function() {
        const searchInput = document.querySelector('input[name="search"]');
        const anneeSelect = document.getElementById('annee');
        const resultsContainer = document.getElementById('results');

        if (!resultsContainer) return;

        function buildUrl() {
            const params = new URLSearchParams();
            const s = (searchInput && searchInput.value) ? searchInput.value : '';
            const a = (anneeSelect && anneeSelect.value) ? anneeSelect.value : '';
            if (s) params.set('search', s);
            if (a) params.set('annee', a);
            return '/home' + (params.toString() ? ('?' + params.toString()) : '');
        }

        let debounceTimer = null;
        function debounce(fn, delay) {
            return function(...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => fn.apply(this, args), delay);
            }
        }

        async function fetchAndReplace() {
            const url = buildUrl();
            try {
                const resp = await fetch(url, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (!resp.ok) return;
                const text = await resp.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const newResults = doc.getElementById('results');
                if (newResults) {
                    resultsContainer.innerHTML = newResults.innerHTML;
                } else {
                    // fallback: try to extract the table body
                    const newTbody = doc.querySelector('#apprentisTable tbody');
                    if (newTbody) {
                        const oldTbody = document.querySelector('#apprentisTable tbody');
                        if (oldTbody) oldTbody.innerHTML = newTbody.innerHTML;
                    }
                }
                // mettre à jour l'URL sans recharger
                history.replaceState(null, '', url);
            } catch (e) {
                console.error('Erreur lors du rechargement des résultats :', e);
            }
        }

        const debouncedFetch = debounce(fetchAndReplace, 400);

        if (searchInput) {
            searchInput.addEventListener('input', debouncedFetch);
            // aussi pour Enter key - laisse le bouton fonctionner normalement
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    fetchAndReplace();
                }
            });
        }

        if (anneeSelect) {
            // on change, on recharge
            anneeSelect.addEventListener('change', (e) => {
                if (e && e.preventDefault) e.preventDefault();
                fetchAndReplace();
            });
        }

    })();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
</body>
</html>